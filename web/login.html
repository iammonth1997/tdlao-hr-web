<!DOCTYPE html>
<html lang="lo">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TDLAO HR - Login</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Saira:wght@400;600;700;800&family=Noto+Sans+Lao:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="../js/lang.js"></script>
  <script src="../js/auth.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --red:    #cc0000;
      --red2:   #ff2222;
      --dark:   #0d1117;
      --card:   #131a24;
      --border: #1e2a38;
      --text:   #ffffff;
      --muted:  #8899aa;
    }

    body {
      font-family: "Saira", "Noto Sans Lao", sans-serif;
      background: var(--dark);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    /* Background grid effect */
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background-image:
        linear-gradient(rgba(204,0,0,0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(204,0,0,0.03) 1px, transparent 1px);
      background-size: 40px 40px;
      pointer-events: none;
    }

    .logo-wrap {
      text-align: center;
      margin-bottom: 32px;
    }

    .logo-icon {
      width: 64px;
      height: 64px;
      background: var(--red);
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      font-weight: 800;
      margin: 0 auto 12px;
      box-shadow: 0 0 30px rgba(204,0,0,0.4);
    }

    .logo-wrap h1 {
      font-size: 22px;
      font-weight: 800;
      letter-spacing: 2px;
      color: var(--text);
    }

    .logo-wrap p {
      font-size: 13px;
      color: var(--muted);
      margin-top: 4px;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 32px 28px;
      width: 100%;
      max-width: 380px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    }

    .lang-row {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 24px;
    }

    .lang-btn {
      background: var(--border);
      border: none;
      padding: 5px 14px;
      color: var(--muted);
      font-size: 12px;
      font-weight: 600;
      border-radius: 20px;
      cursor: pointer;
      transition: 0.2s;
      font-family: inherit;
    }

    .lang-btn:hover, .lang-btn.active {
      background: var(--red);
      color: white;
    }

    .field {
      margin-bottom: 18px;
    }

    .field label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: var(--muted);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .field input {
      width: 100%;
      padding: 14px 16px;
      background: var(--dark);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text);
      font-size: 16px;
      font-family: inherit;
      transition: 0.2s;
      outline: none;
    }

    .field input:focus {
      border-color: var(--red);
      box-shadow: 0 0 0 3px rgba(204,0,0,0.15);
    }

    .pin-row {
      display: flex;
      gap: 8px;
    }

    .pin-digit {
      flex: 1;
      padding: 14px 0;
      text-align: center;
      background: var(--dark);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text);
      font-size: 20px;
      font-weight: 700;
      font-family: inherit;
      transition: 0.2s;
      outline: none;
    }

    .pin-digit:focus {
      border-color: var(--red);
      box-shadow: 0 0 0 3px rgba(204,0,0,0.15);
    }

    .error-msg {
      background: rgba(204,0,0,0.1);
      border: 1px solid rgba(204,0,0,0.3);
      color: #ff6666;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 14px;
      margin-bottom: 16px;
      display: none;
      text-align: center;
    }

    .error-msg.show { display: block; }

    .login-btn {
      width: 100%;
      padding: 15px;
      background: var(--red);
      border: none;
      border-radius: 10px;
      color: white;
      font-size: 16px;
      font-weight: 700;
      font-family: inherit;
      cursor: pointer;
      transition: 0.2s;
      margin-top: 8px;
      position: relative;
      overflow: hidden;
    }

    .login-btn:hover { background: var(--red2); transform: translateY(-1px); }
    .login-btn:active { transform: translateY(0); }
    .login-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

    .step-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
    }

    .back-btn {
      background: none;
      border: 1px solid var(--border);
      color: var(--muted);
      padding: 6px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      font-family: inherit;
      transition: 0.2s;
    }

    .back-btn:hover { border-color: var(--red); color: var(--text); }

    .emp-label {
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
    }

    input[type="date"] {
      width: 100%;
      padding: 14px 16px;
      background: var(--dark);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text);
      font-size: 16px;
      font-family: inherit;
      transition: 0.2s;
      outline: none;
    }

    input[type="date"]:focus {
      border-color: var(--red);
      box-shadow: 0 0 0 3px rgba(204,0,0,0.15);
    }
  </style>
</head>
<body>

  <div class="logo-wrap">
    <div class="logo-icon">TD</div>
    <h1>TDLAO HR</h1>
    <p>Employee Self-Service Portal</p>
  </div>

  <div class="card">

    <div class="lang-row">
      <button class="lang-btn" onclick="setLangActive('lo')">LAO</button>
      <button class="lang-btn" onclick="setLangActive('th')">ไทย</button>
      <button class="lang-btn" onclick="setLangActive('en')">EN</button>
    </div>

    <!-- Step 1: Employee ID -->
    <div id="stepEmp">
      <div class="field">
        <label data-lang="emp_id">ລະຫັດພະນັກງານ</label>
        <input type="text" id="empId" placeholder="e.g. L2506110" autocomplete="off" autocapitalize="characters" />
      </div>
      <div class="error-msg" id="errEmp"></div>
      <button class="login-btn" id="checkBtn" onclick="doCheck()">ຕໍ່ໄປ / ถัดไป</button>
    </div>

    <!-- Step 2a: Login (already registered) -->
    <div id="stepLogin" style="display:none">
      <div class="step-header">
        <button class="back-btn" onclick="goBack()">← ກັບ</button>
        <span id="empDisplay" class="emp-label"></span>
      </div>
      <div class="field">
        <label data-lang="pin">PIN 6 ຕົວເລກ</label>
        <div class="pin-row" id="pinRowLogin">
          <input class="pin-digit" type="password" maxlength="1" inputmode="numeric" />
          <input class="pin-digit" type="password" maxlength="1" inputmode="numeric" />
          <input class="pin-digit" type="password" maxlength="1" inputmode="numeric" />
          <input class="pin-digit" type="password" maxlength="1" inputmode="numeric" />
          <input class="pin-digit" type="password" maxlength="1" inputmode="numeric" />
          <input class="pin-digit" type="password" maxlength="1" inputmode="numeric" />
        </div>
      </div>
      <div class="error-msg" id="errLogin"></div>
      <button class="login-btn" id="loginBtn" onclick="doLogin()">ເຂົ້າສູ່ລະບົບ</button>
    </div>

    <!-- Step 2b: Register (first time) -->
    <div id="stepRegister" style="display:none">
      <div class="step-header">
        <button class="back-btn" onclick="goBack()">← ກັບ</button>
        <span class="emp-label">ລົງທະບຽນຄັ້ງທຳອິດ</span>
      </div>
      <div class="field">
        <label>ວັນເດືອນປີເກີດ / วันเกิด (DOB)</label>
        <input type="date" id="dobInput" />
      </div>
      <div class="field">
        <label>ຕັ້ງ PIN 6 ຕົວເລກ</label>
        <div class="pin-row" id="pinRowNew">
          <input class="pin-digit" type="password" maxlength="1" inputmode="numeric" />
          <input class="pin-digit" type="password" maxlength="1" inputmode="numeric" />
          <input class="pin-digit" type="password" maxlength="1" inputmode="numeric" />
          <input class="pin-digit" type="password" maxlength="1" inputmode="numeric" />
          <input class="pin-digit" type="password" maxlength="1" inputmode="numeric" />
          <input class="pin-digit" type="password" maxlength="1" inputmode="numeric" />
        </div>
      </div>
      <div class="field">
        <label>ຢືນຢັນ PIN</label>
        <div class="pin-row" id="pinRowConfirm">
          <input class="pin-digit" type="password" maxlength="1" inputmode="numeric" />
          <input class="pin-digit" type="password" maxlength="1" inputmode="numeric" />
          <input class="pin-digit" type="password" maxlength="1" inputmode="numeric" />
          <input class="pin-digit" type="password" maxlength="1" inputmode="numeric" />
          <input class="pin-digit" type="password" maxlength="1" inputmode="numeric" />
          <input class="pin-digit" type="password" maxlength="1" inputmode="numeric" />
        </div>
      </div>
      <div class="error-msg" id="errReg"></div>
      <button class="login-btn" id="regBtn" onclick="doRegister()">ລົງທະບຽນ &amp; ເຂົ້າລະບົບ</button>
    </div>

  </div>

  <script src="../js/api.js"></script>
  <script>
    getAuth();

    let currentEmpId = "";

    // --- Lang ---
    function setLangActive(code) {
      setLang(code);
      document.querySelectorAll(".lang-btn").forEach((btn, i) => {
        btn.classList.toggle("active", ["lo","th","en"][i] === code);
      });
    }
    const currentLang = localStorage.getItem("lang") || "lo";
    document.querySelectorAll(".lang-btn").forEach((btn, i) => {
      btn.classList.toggle("active", ["lo","th","en"][i] === currentLang);
    });

    // --- PIN helpers ---
    function setupPinRow(rowId, onComplete) {
      const inputs = document.querySelectorAll(`#${rowId} .pin-digit`);
      inputs.forEach((input, i) => {
        input.addEventListener("input", () => {
          input.value = input.value.replace(/\D/g, "");
          if (input.value && i < inputs.length - 1) inputs[i + 1].focus();
          if (input.value && i === inputs.length - 1 && onComplete) onComplete();
        });
        input.addEventListener("keydown", e => {
          if (e.key === "Backspace" && !input.value && i > 0) inputs[i - 1].focus();
        });
      });
      return inputs;
    }

    function getPinFromRow(rowId) {
      return Array.from(document.querySelectorAll(`#${rowId} .pin-digit`)).map(i => i.value).join("");
    }

    function clearPinRow(rowId) {
      document.querySelectorAll(`#${rowId} .pin-digit`).forEach(i => i.value = "");
    }

    function focusPinRow(rowId) {
      document.querySelector(`#${rowId} .pin-digit`).focus();
    }

    setupPinRow("pinRowLogin", doLogin);
    setupPinRow("pinRowNew");
    setupPinRow("pinRowConfirm", doRegister);

    document.getElementById("empId").addEventListener("keydown", e => {
      if (e.key === "Enter") doCheck();
    });

    // --- Navigation ---
    function showStep(step) {
      ["stepEmp", "stepLogin", "stepRegister"].forEach(id => {
        document.getElementById(id).style.display = id === step ? "block" : "none";
      });
    }

    function goBack() {
      currentEmpId = "";
      showStep("stepEmp");
      document.getElementById("empId").focus();
    }

    function showError(id, msg) {
      const el = document.getElementById(id);
      el.textContent = msg;
      el.classList.add("show");
    }

    function clearError(id) {
      const el = document.getElementById(id);
      el.textContent = "";
      el.classList.remove("show");
    }

    // --- Step 1: Check emp_id ---
    async function doCheck() {
      const empId = document.getElementById("empId").value.trim().toUpperCase();
      clearError("errEmp");

      if (!empId) { showError("errEmp", "ກະລຸນາໃສ່ລະຫັດພະນັກງານ"); return; }

      const btn = document.getElementById("checkBtn");
      btn.disabled = true;
      btn.textContent = "...";

      const res = await callAPI("check", { emp: empId });

      btn.disabled = false;
      btn.textContent = "ຕໍ່ໄປ / ถัดไป";

      if (!res || !res.exists) {
        showError("errEmp", "ບໍ່ພົບລະຫັດພະນັກງານ / ไม่พบรหัสพนักงาน");
        return;
      }
      if (!res.active) {
        showError("errEmp", "ບັນຊີຖືກລະງັບ (ລາອອກ) / บัญชีถูกระงับ (ลาออก)");
        return;
      }

      currentEmpId = empId;
      document.getElementById("empDisplay").textContent = empId;

      if (res.registered) {
        showStep("stepLogin");
        focusPinRow("pinRowLogin");
      } else {
        showStep("stepRegister");
        document.getElementById("dobInput").focus();
      }
    }

    // --- Step 2a: Login ---
    async function doLogin() {
      const pin = getPinFromRow("pinRowLogin");
      clearError("errLogin");

      if (pin.length !== 6) { showError("errLogin", "ກະລຸນາໃສ່ PIN 6 ຕົວ"); return; }

      const btn = document.getElementById("loginBtn");
      btn.disabled = true;
      btn.textContent = t("loading");

      const res = await callAPI("login", { emp: currentEmpId, pin });

      btn.disabled = false;
      btn.textContent = t("login_btn");

      if (res && res.token) {
        saveAuth(currentEmpId, res.token, Number(res.expires_in) || 28800);
        window.location.replace("/web/index.html");
      } else {
        showError("errLogin", res && res.error === "Account suspended"
          ? "ບັນຊີຖືກລະງັບ (ລາອອກ)"
          : "PIN ບໍ່ຖືກຕ້ອງ / PIN ไม่ถูกต้อง");
        clearPinRow("pinRowLogin");
        focusPinRow("pinRowLogin");
      }
    }

    // --- Step 2b: Register (first time) ---
    async function doRegister() {
      const dob = document.getElementById("dobInput").value;
      const pin = getPinFromRow("pinRowNew");
      const pinConfirm = getPinFromRow("pinRowConfirm");
      clearError("errReg");

      if (!dob) { showError("errReg", "ກະລຸນາໃສ່ວັນເກີດ / กรุณาใส่วันเกิด"); return; }
      if (pin.length !== 6) { showError("errReg", "ກະລຸນາໃສ່ PIN 6 ຕົວ"); return; }
      if (pin !== pinConfirm) {
        showError("errReg", "PIN ບໍ່ຕົງກັນ / PIN ไม่ตรงกัน");
        clearPinRow("pinRowConfirm");
        focusPinRow("pinRowConfirm");
        return;
      }

      const btn = document.getElementById("regBtn");
      btn.disabled = true;
      btn.textContent = "...";

      const deviceId = localStorage.getItem("tdlao_device_id") || crypto.randomUUID();
      localStorage.setItem("tdlao_device_id", deviceId);

      const res = await callAPI("register", { emp: currentEmpId, pin, dob, device_id: deviceId });

      btn.disabled = false;
      btn.textContent = "ລົງທະບຽນ & ເຂົ້າລະບົບ";

      if (res && res.token) {
        saveAuth(currentEmpId, res.token, Number(res.expires_in) || 28800);
        window.location.replace("/web/index.html");
      } else {
        const code = res && res.code;
        let msg = "ເກີດຂໍ້ຜິດພາດ / เกิดข้อผิดพลาด";
        if (code === "DOB_MISMATCH") msg = "ວັນເກີດບໍ່ຖືກຕ້ອງ / วันเกิดไม่ถูกต้อง";
        if (code === "RESIGNED") msg = "ບັນຊີຖືກລະງັບ (ລາອອກ) / บัญชีถูกระงับ";
        if (code === "ALREADY_REGISTERED") msg = "ລົງທະບຽນແລ້ວ ກະລຸນາ Login / ลงทะเบียนแล้ว กรุณา Login";
        showError("errReg", msg);
      }
    }
  </script>
</body>
</html>
