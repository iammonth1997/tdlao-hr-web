<!DOCTYPE html>
<html lang="lo">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Salary Slip</title>
  <link href="https://fonts.googleapis.com/css2?family=Saira:wght@400;600;700;800&family=Noto+Sans+Lao:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="../js/lang.js"></script>
  <script src="../js/auth.js"></script>
  <style>
    *, *::before, *::after { box-sizing:border-box; margin:0; padding:0; }
    :root { --red:#cc0000; --dark:#0d1117; --card:#131a24; --border:#1e2a38; --text:#ffffff; --muted:#8899aa; --green:#00cc66; }
    body { font-family:"Saira","Noto Sans Lao",sans-serif; background:var(--dark); color:var(--text); min-height:100vh; padding-bottom:40px; }
    .header { background:#000; border-bottom:3px solid var(--red); padding:16px 20px; display:flex; align-items:center; gap:12px; }
    .back-btn { background:var(--border); border:none; color:var(--text); width:36px; height:36px; border-radius:10px; font-size:18px; cursor:pointer; display:flex; align-items:center; justify-content:center; }
    .header h1 { font-size:18px; font-weight:700; }
    .content { padding:20px; }

    .slip-card {
      background: #fff; color:#000;
      border-radius:14px; overflow:hidden;
      margin-bottom:20px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.4);
    }
    .slip-header {
      background: var(--red); color:#fff;
      padding:20px; text-align:center;
    }
    .slip-header h2 { font-size:16px; font-weight:800; letter-spacing:1px; }
    .slip-header p  { font-size:12px; opacity:0.85; margin-top:4px; }
    .slip-emp { padding:16px 20px; border-bottom:1px solid #eee; background:#fafafa; }
    .slip-emp .name { font-size:16px; font-weight:700; color:#000; }
    .slip-emp .meta { font-size:12px; color:#666; margin-top:3px; }

    .slip-section { padding:0 20px; }
    .slip-section-title { font-size:11px; font-weight:700; color:#999; text-transform:uppercase; letter-spacing:0.5px; padding:14px 0 8px; border-bottom:1px solid #eee; margin-bottom:4px; }
    .slip-row { display:flex; justify-content:space-between; padding:9px 0; border-bottom:1px solid #f5f5f5; }
    .slip-row:last-child { border:none; }
    .slip-row .lbl { font-size:14px; color:#333; }
    .slip-row .val { font-size:14px; font-weight:700; color:#000; }
    .slip-row .val.income { color:#006600; }
    .slip-row .val.deduct { color:#cc0000; }

    .slip-net {
      background: linear-gradient(135deg, #006600, #009900);
      color:#fff; padding:20px; text-align:center;
    }
    .slip-net .lbl { font-size:13px; opacity:0.85; }
    .slip-net .val { font-size:28px; font-weight:800; margin-top:4px; }

    .pdf-btn {
      width:100%; padding:16px; background:var(--red); border:none;
      border-radius:10px; color:#fff; font-size:16px; font-weight:700;
      font-family:inherit; cursor:pointer; transition:0.2s;
    }
    .pdf-btn:hover { background:#ff2222; }

    .loading-wrap { text-align:center; padding:60px 20px; }
    .loading-wrap p { color:var(--muted); margin-top:12px; }
    .spinner { width:36px; height:36px; border:3px solid var(--border); border-top-color:var(--red); border-radius:50%; animation:spin 0.8s linear infinite; margin:0 auto; }
    @keyframes spin { to { transform:rotate(360deg); } }
    .error-wrap { text-align:center; padding:60px 20px; display:none; }
    .error-wrap p { color:var(--muted); margin-top:12px; }
  </style>
</head>
<body>
  <div class="header">
    <button class="back-btn" onclick="history.back()">←</button>
    <h1 data-lang="salary_title">ສະລິບເງິນເດືອນ</h1>
  </div>

  <div class="content">
    <div class="loading-wrap" id="loadingWrap">
      <div class="spinner"></div>
      <p data-lang="loading">ກຳລັງໂຫລດ...</p>
    </div>
    <div class="error-wrap" id="errorWrap">
      <div style="font-size:40px">⚠️</div>
      <p id="errorMsg">ບໍ່ພົບຂໍ້ມູນ</p>
    </div>

    <div id="dataWrap" style="display:none">
      <div class="slip-card">
        <div class="slip-header">
          <h2>SALARY SLIP · ສະລິບເງິນເດືອນ</h2>
          <p id="slipPeriod">-</p>
        </div>
        <div class="slip-emp">
          <div class="name" id="empName">-</div>
          <div class="meta" id="empMeta">-</div>
        </div>

        <div class="slip-section">
          <div class="slip-section-title">ລາຍໄດ້ / Income</div>
          <div class="slip-row"><span class="lbl">ເງິນເດືອນ / Salary</span>         <span class="val income" id="salary">-</span></div>
          <div class="slip-row"><span class="lbl">ຄ່າກະ / Shift</span>              <span class="val income" id="shift">-</span></div>
          <div class="slip-row"><span class="lbl">ຄ່າທັກສະ / Skill</span>           <span class="val income" id="skill">-</span></div>
          <div class="slip-row"><span class="lbl">ສະຫວັດດີການອື່ນໆ / Other</span>   <span class="val income" id="welfare">-</span></div>
          <div class="slip-row"><span class="lbl">ລາຍໄດ້ອື່ນໆ / Misc</span>          <span class="val income" id="misc">-</span></div>
          <div class="slip-row" style="font-weight:700">
            <span class="lbl">ລວມລາຍໄດ້ / Total Income</span>
            <span class="val income" id="totalIncome">-</span>
          </div>
        </div>

        <div class="slip-section">
          <div class="slip-section-title">ລາຍຫັກ / Deductions</div>
          <div class="slip-row"><span class="lbl">ຫັກ ປະກັນສັງຄົມ 5.5%</span>      <span class="val deduct" id="sso">-</span></div>
          <div class="slip-row"><span class="lbl">ຫັກ ພາສີ / Tax</span>              <span class="val deduct" id="tax">-</span></div>
          <div class="slip-row"><span class="lbl">ຫັກອື່ນໆ / Other deduct</span>     <span class="val deduct" id="deductOther">-</span></div>
          <div class="slip-row" style="font-weight:700">
            <span class="lbl">ລວມຫັກ / Total Deduct</span>
            <span class="val deduct" id="totalDeduct">-</span>
          </div>
        </div>

        <div class="slip-net">
          <div class="lbl">ລາຍໄດ້ສຸດທິ / NET PAY</div>
          <div class="val" id="netPay">-</div>
        </div>
      </div>

      <button class="pdf-btn" id="pdfBtn" data-lang="download_pdf">ດາວໂຫລດ PDF</button>
    </div>
  </div>

  <script src="../js/api.js"></script>
  <script>
    requireAuth();

    const p = new URLSearchParams(location.search);
    const month = p.get("month"), year = p.get("year");

    function fmt(v) {
      if (v === null || v === undefined || v === "" || v === "-") return "-";
      return Number(v).toLocaleString() + " ກີບ";
    }

    async function loadData() {
      try {
        const data = await callAPI("salary", { month, year });
        document.getElementById("loadingWrap").style.display = "none";

        if (!data || data.error) {
          document.getElementById("errorWrap").style.display = "block";
          document.getElementById("errorMsg").textContent = data?.error || "ບໍ່ພົບຂໍ້ມູນ";
          return;
        }

        document.getElementById("dataWrap").style.display = "block";
        document.getElementById("slipPeriod").textContent  = `${month} / ${year}`;
        document.getElementById("empName").textContent     = data.name     || "-";
        document.getElementById("empMeta").textContent     = `${data.empcode || ""} · ${data.position || ""} · ${data.department || ""}`;
        document.getElementById("salary").textContent      = fmt(data.salary);
        document.getElementById("shift").textContent       = fmt(data.shift);
        document.getElementById("skill").textContent       = fmt(data.skill);
        document.getElementById("welfare").textContent     = fmt(data.welfare);
        document.getElementById("misc").textContent        = fmt(data.misc);
        document.getElementById("totalIncome").textContent = fmt(data.total_income);
        document.getElementById("sso").textContent         = fmt(data.sso);
        document.getElementById("tax").textContent         = fmt(data.tax);
        document.getElementById("deductOther").textContent = fmt(data.deduct_other);
        document.getElementById("totalDeduct").textContent = fmt(data.total_deduct);
        document.getElementById("netPay").textContent      = fmt(data.net);
      } catch (err) {
        document.getElementById("loadingWrap").style.display = "none";
        document.getElementById("errorWrap").style.display = "block";
        document.getElementById("errorMsg").textContent = err.message;
      }
    }

    document.getElementById("pdfBtn").onclick = async () => {
      const pdf = await callAPI("salary-pdf", { month, year });
      if (pdf?.url) window.open(pdf.url, "_blank");
    };

    loadData();
  </script>
</body>
</html>
